--Non abbiamo per ora le MQT, dobbiamo sostituirle con le nostre MQT

SELECT
    ORD_ESEC.NUMERO_ORD_FMT AS DOC_ID,
    ORD_ESEC.ID_ANNO_ORD AS ANNO_DOC,
    TRIM(RIGHT( ORD_ESEC.ID_NUMERO_ORD, 6)) AS NUM_DOC,
    TRIM(LEFT( ORD_ESEC.ID_NUMERO_ORD, 3)) AS SERIE_DOC,
    ORD_ESEC.DATA_ORDINE AS DATA_DOC,
    --
CASE WHEN TRIM( RIGHT( ORD_ESEC.ID_NUMERO_ORD, 6 )) BETWEEN '020000' AND '029999'  THEN '00005074' ELSE CLIENTI.CLICFEST END AS COD_CF,
    --
ORD_ESEC_MAME.NOTE_MOD_SCHEDA AS NOTE_INT,
    ORD_ESEC_MAME.NOTE_SCH_PROD AS NOTE_STAMPA,
    'OP' AS COD_CAUS_DOC,
    NOTE_CONSE_MP.DESCRIZIONE AS NOTE_CONSEGNA,
    --
CASE WHEN ORD_ESEC.R_MAGAZZINO_PRL IN('MP', 'SB', 'MR')  THEN '1.01' ELSE ORD_ESEC.R_MAGAZZINO_PRL END AS COD_DEP,
    --
CASE WHEN TRIM( RIGHT( ORD_ESEC.ID_NUMERO_ORD, 6 )) BETWEEN '020000' AND '029999' THEN 'DIPICO' ELSE YORD_VEN_RIG.COD_ART_TARGET END AS COD_ART,
    --
ART_TECNICO.R_ART_TECNICO AS COD_VAR_MATERIALE,
    moepe.ID_LOTTO_PRTN AS COD_LOT,
    ARTICOLI_PRD.DESCRIZIONE AS DES_PROD,
    ORD_ESEC.QTA_ORD_UM_PRM AS QUANT_DA_PROD,
    --
CASE WHEN TRIM( RIGHT( ORD_ESEC.ID_NUMERO_ORD, 6 )) BETWEEN '020000' AND '029999'
	THEN RTRIM(ORD_ESEC.ID_ANNO_ORD)|| '-ORDC-0000000-001'
    ELSE RTRIM(ORD_ESEC.R_ANNO_ORD_CLI)|| '-ORDC-000' || substr( ORD_ESEC.R_NUMERO_ORD_CLI, 6, 4 )|| '-' || RIGHT( CONCAT( '000', ORD_ESEC.R_RIGA_ORD_CLI ), 3 )
END AS RIF_RIGA_ORD_CLI_4B,
--
ORD_ESEC.R_UTENTE_CRZ AS UTENTE_INS,
ORD_ESEC.TIMESTAMP_CRZ AS DATA_INS,
ORD_ESEC.R_UTENTE_AGG AS UTENTE_MOD,
MAX(COALESCE( ORD_ESEC.TIMESTAMP_AGG, '1900-01-01' ), COALESCE( ORD_VEN_RIG.TIMESTAMP_AGG, '1900-01-01' )) AS DATA_MOD,
YORD_VEN_RIG.YPESO_GREZZO AS PESGREZ,
NULL AS PESMULT,
NULL AS CHIODAIA,
NULL AS MANDRINO,
NULL AS ATTREZZ1,
NULL AS ATTREZZ2,
ORD_ESEC_MAME.NUMERO_PROVA AS PROVNUM,
--
NULL AS DATA_SPED,
NULL AS DATA_TT,
COALESCE(ORD_ESEC_MAME.YMATRICOLA_CLI, YORD_VEN_RIG.YMATRICOLA_CLI) AS IDENTCLI,
CASE
    WHEN LEFT(ORD_VEN_RIG.R_ARTICOLO, 1) IN('U', 'X') THEN 1
    ELSE 0
END NUCLEARE,
--
COALESCE(ord_esec_mame.PART_NUMBER, ord_ven_mame.part_number) AS CODCLI,
0 AS TIPO_OPERAZIONE,
0 AS ESEGUITO,
1 AS NUM_RIGA,
ORD_ESEC.NUMERO_ORD_FMT || '/' || '0001' AS DOC_RIGA_ID,
COALESCE(ART_TECNICO.R_CLASSE_FISCALE, '000.0') AS COD_ART_COMP,
moepe_mat.MAT_QTA_PRL_UM_PRM_CHLD * moepe_mat.COEF_RISORSA AS QUANT_SCARICATA,
0 AS QUANT_MATEROZZA,
COALESCE(moepe_mat.ID_LOTTO_MAT_CHLD, '' ) AS ENTRATA,
CASE
    WHEN ORD_ESEC.DATA_INIZIO_EFF = '0001-01-01' THEN ORD_ESEC.DATA_INIZIO_PGM
    ELSE ORD_ESEC.DATA_INIZIO_PGM
END AS DATA_MOVIMENTO
--
FROM (SELECT * FROM MAME.MQT_ORD_ESEC_PARENTCHILD_ESEPRD WHERE GENERATION = 9  ) moepe
--
INNER JOIN ( SELECT * FROM MAME.MQT_ORD_ESEC_PARENTCHILD_ESEPRD q_moepe
WHERE
GENERATION = (
SELECT
    Min(mmoepe.GENERATION)
FROM
    MAME.MQT_ORD_ESEC_PARENTCHILD_ESEPRD mmoepe
WHERE
    (mmoepe.R_CONFIGURAZIONE_MAT_CHLD IS NOT NULL
        OR mmoepe.R_MAGAZZINO_PRL_MAT_CHLD IN('CL'))
        AND mmoepe.ID_AZIENDA_PRTN = q_moepe.ID_AZIENDA_PRTN
        AND mmoepe.ID_ANNO_ORD_PRTN = q_moepe.ID_ANNO_ORD_PRTN
        AND mmoepe.ID_NUMERO_ORD_PRTN = q_moepe.ID_NUMERO_ORD_PRTN
        AND mmoepe.ID_LOTTO_PRTN = q_moepe.ID_LOTTO_PRTN)
	) moepe_mat
ON
moepe_mat.ID_AZIENDA_PRTN = moepe.ID_AZIENDA_PRTN
AND moepe_mat.ID_ANNO_ORD_PRTN = moepe.ID_ANNO_ORD_PRTN
AND moepe_mat.ID_NUMERO_ORD_PRTN = moepe.ID_NUMERO_ORD_PRTN
AND moepe_mat.ID_LOTTO_PRTN = moepe.ID_LOTTO_PRTN
--
INNER JOIN THIP.ARTICOLI AS ART_TECNICO
ON
ART_TECNICO.ID_AZIENDA = moepe_mat.ID_AZIENDA_PRTN
AND ART_TECNICO.ID_ARTICOLO = moepe_mat.R_ARTICOLO_MAT_CHLD
--
INNER JOIN THIP.ORD_ESEC ORD_ESEC
ON
ORD_ESEC.ID_AZIENDA = moepe.ID_AZIENDA_PRTN
AND ORD_ESEC.ID_ANNO_ORD = moepe.ID_ANNO_ORD_PRTN
AND ORD_ESEC.ID_NUMERO_ORD = moepe.ID_NUMERO_ORD_PRTN
--
INNER JOIN MAME.ORD_ESEC_MAME ORD_ESEC_MAME
ON
ORD_ESEC.ID_AZIENDA = ORD_ESEC_MAME.ID_AZIENDA
AND ORD_ESEC.ID_ANNO_ORD = ORD_ESEC_MAME.ID_ANNO_ORD
AND ORD_ESEC.ID_NUMERO_ORD = ORD_ESEC_MAME.ID_NUMERO_ORD
--
INNER JOIN THIP.CLIENTI CLIENTI
ON
CLIENTI.T01CD = ORD_ESEC.ID_AZIENDA
AND CLIENTI.CLICD = ORD_ESEC.R_CLIENTE
--
LEFT JOIN MAME.NOTE_CONSE_MP NOTE_CONSE_MP
ON
NOTE_CONSE_MP.ID_AZIENDA = ORD_ESEC_MAME.ID_AZIENDA
AND NOTE_CONSE_MP.CODICE = ORD_ESEC_MAME.CODICE_CONSEGNA
--
INNER JOIN THIP.ORD_VEN_RIG ORD_VEN_RIG
ON
ORD_ESEC.ID_AZIENDA = ORD_VEN_RIG.ID_AZIENDA
AND ORD_ESEC.R_ANNO_ORD_CLI = ORD_VEN_RIG.ID_ANNO_ORD
AND ORD_ESEC.R_NUMERO_ORD_CLI = ORD_VEN_RIG.ID_NUMERO_ORD
AND ORD_ESEC.R_RIGA_ORD_CLI = ORD_VEN_RIG.ID_RIGA_ORD
AND ORD_ESEC.R_DET_RIGA_ORD = ORD_VEN_RIG.ID_DET_RIGA_ORD
--
INNER JOIN THIPPERS.YORD_VEN_RIG YORD_VEN_RIG
ON
ORD_VEN_RIG.ID_AZIENDA = YORD_VEN_RIG.ID_AZIENDA
AND ORD_VEN_RIG.ID_ANNO_ORD = YORD_VEN_RIG.ID_ANNO_ORD
AND ORD_VEN_RIG.ID_NUMERO_ORD = YORD_VEN_RIG.ID_NUMERO_ORD
AND ORD_VEN_RIG.ID_RIGA_ORD = YORD_VEN_RIG.ID_RIGA_ORD
AND ORD_VEN_RIG.ID_DET_RIGA_ORD = YORD_VEN_RIG.ID_DET_RIGA_ORD
--
INNER JOIN THIPPERS.Y_ORD_VEN_TES ORD_VEN_MAME
ON
ORD_VEN_RIG.ID_AZIENDA = ORD_VEN_MAME.ID_AZIENDA
AND ORD_VEN_RIG.ID_ANNO_ORD = ORD_VEN_MAME.ID_ANNO_ORD
AND ORD_VEN_RIG.ID_NUMERO_ORD = ORD_VEN_MAME.ID_NUMERO_ORD
AND ORD_VEN_RIG.ID_RIGA_ORD = ORD_VEN_MAME.ID_RIGA_ORD
--
INNER JOIN THIP.ARTICOLI AS ARTICOLI_PRD
ON
ARTICOLI_PRD.ID_AZIENDA = YORD_VEN_RIG.ID_AZIENDA
AND ARTICOLI_PRD.ID_ARTICOLO = YORD_VEN_RIG.COD_ART_TARGET
--
WHERE ORD_ESEC.STATO = 'V'
AND ORD_ESEC.STATO_ORDINE IN (1, 3)
AND ORD_ESEC_MAME.DT_START_PRD IS NOT NULL
AND moepe_mat.stato_prl_mat_chld = '2';